Param(
  [string]$Temp,
  [String]$CertName,
	[String]$CAServer
)

$master = "<%= @puppetserver %>"
$ca = "<%= @caserver %>"
$puppet = "<%= @puppet_bat %>"
$source = "https://<%= @puppetserver %>:8140/packages/current/windows"
$package = "<%= @msi %>"
$install = "$temp\$source /qn"

function downloadPuppet {
  [System.Net.ServicePointManager]::ServerCertificateValidationCallback={$true}
  $uri = "$source/$package"
  $obj = New-Object System.Net.WebClient
  $link = $obj.DownloadString($uri)
  Write-Host "Downloading Puppet Enterprise <%= @pe_build %> on $env:COMPUTERNAME..."
  Invoke-WebRequest $uri -OutFile $temp\$package
}

function installPuppet {
  $install = "$temp\$package"
  $opts = @("/qn")
  If ($CAServer) { $opts += "PUPPET_CA_SERVER=$CAServer "}
  If ($CertName) { $opts += "PUPPET_AGENT_CERTNAME=$CertName "}
  Write-Host "Installing Puppet Enterprise <%= @pe_build %> on $env:COMPUTERNAME..."
  Start-Process $install $opts -Wait
}

function validateInstall {
  If ((Get-WmiObject -Class Win32_Product).Name -match 'Puppet') {
    Write-Host "Puppet Enterprise has been installed on $env:COMPUTERNAME"
  } else {
    Throw {
      "Something went wrong with the installation on $env:COMPUTERNAME.  Check the event log."
    }
  }
}

function configurePuppet {
  Write-Host "Configuring Puppet Enterprise <%= @pe_build %> on $env:COMPUTERNAME..."
  If ($CertName) {
    Invoke-Command -ScriptBlock { cmd.exe /c $puppet config set certname $CertName --section main }
  }
  If ($CAServer) { 
    Invoke-Command -ScriptBlock { cmd.exe /c $puppet config set ca_server $CAServer --section main }
  } else {
    Invoke-Command -ScriptBlock { cmd.exe /c $puppet config set ca_server $master --section main }
  }
  Invoke-Command -ScriptBlock { cmd.exe /c $puppet config set server $master --section main }
  #Invoke-Command -ScriptBlock { cmd.exe /c $puppet config set archive_file_server $master --section main }
}

downloadPuppet

$params = @{}
If ($CAServer) { $params += @{ CAServer = $CAServer } }
If ($CertName) { $params += @{ CertName = $CertName } }

installPuppet @params

validateInstall

configurePuppet

Write-Host "Installation has completed..."
